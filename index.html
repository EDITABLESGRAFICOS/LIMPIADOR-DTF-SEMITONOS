<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Limpiador de Semitonos - Profesional</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f9f9f9; }
  canvas { border: 1px solid #ccc; margin-top: 15px; max-width: 100%; }
  button { margin: 5px; padding: 10px 25px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; }
  #process { background-color: #4CAF50; color: white; }
  #toggle { background-color: #FF9800; color: white; }
  #clean { background-color: #2196F3; color: white; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  #info { margin-top: 10px; font-weight: bold; color: #333; }
</style>
</head>
<body>
  <h1>Limpiador de Semitonos</h1>
  <input type="file" id="upload" accept="image/png"><br>
  <button id="process" disabled>Procesar Semitransparencias</button>
  <button id="toggle" disabled>Mostrar/Ocultar Overlay</button>
  <button id="clean" disabled>Limpiar Imagen</button>
  <div id="info"></div>
  <br>
  <canvas id="canvas"></canvas>

<script>
const upload = document.getElementById('upload');
const processBtn = document.getElementById('process');
const toggleBtn = document.getElementById('toggle');
const cleanBtn = document.getElementById('clean');
const info = document.getElementById('info');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let originalImage = null;
let overlayData = null;
let overlayVisible = true;
let semitransparentPixels = 0;

// Subir imagen
upload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            originalImage = img;
            processBtn.disabled = false;
            toggleBtn.disabled = true;
            cleanBtn.disabled = true;
            info.textContent = "Imagen cargada. Lista para procesar.";
        }
        img.src = ev.target.result;
    }
    reader.readAsDataURL(file);
});

// Procesar semitransparencias y crear overlay
processBtn.addEventListener('click', () => {
    if (!originalImage) return;

    ctx.drawImage(originalImage, 0, 0);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imgData.data;

    overlayData = ctx.createImageData(imgData);
    semitransparentPixels = 0;

    for (let i = 0; i < data.length; i += 4) {
        const alpha = data[i + 3];
        if (alpha > 0 && alpha < 255) {
            overlayData.data[i] = 255;
            overlayData.data[i + 1] = 0;
            overlayData.data[i + 2] = 0;
            overlayData.data[i + 3] = 128;
            semitransparentPixels++;
        } else {
            overlayData.data[i + 3] = 0;
        }
    }

    ctx.putImageData(imgData, 0, 0);
    ctx.putImageData(overlayData, 0, 0);

    toggleBtn.disabled = false;
    cleanBtn.disabled = false;

    info.textContent = `Se detectaron ${semitransparentPixels} píxeles semitransparentes.`;
});

// Toggle overlay
toggleBtn.addEventListener('click', () => {
    overlayVisible = !overlayVisible;
    ctx.drawImage(originalImage, 0, 0);
    if (overlayVisible && overlayData) {
        ctx.putImageData(overlayData, 0, 0);
    }
});

// Limpiar semitransparencias
cleanBtn.addEventListener('click', () => {
    if (!originalImage) return;

    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imgData.data;

    for (let i = 0; i < data.length; i += 4) {
        if (data[i + 3] > 0 && data[i + 3] < 255) {
            data[i + 3] = 255;
        }
    }

    ctx.putImageData(imgData, 0, 0);

    const link = document.createElement('a');
    link.download = 'imagen_limpia.png';
    link.href = canvas.toDataURL();
    link.click();

    info.textContent = `Se han limpiado ${semitransparentPixels} píxeles semitransparentes. Imagen lista para descargar.`;
});
</script>
</body>
</html>