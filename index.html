<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiador de Semitonos - Profesional</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center p-6">

  <!-- Header -->
  <h1 class="text-3xl font-bold text-blue-600 mb-6">âœ¨ Limpiador de Semitonos</h1>

  <!-- Zona de carga -->
  <div id="drop-zone" 
       class="w-full max-w-xl border-2 border-dashed border-gray-400 bg-white rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 transition">
    <p class="text-gray-600 mb-2">Arrastra una imagen PNG aquÃ­ o</p>
    <input type="file" id="upload" accept="image/png" class="hidden">
    <button onclick="document.getElementById('upload').click()" 
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
      <i data-lucide="upload"></i> Subir Imagen
    </button>
  </div>

  <!-- Botones -->
  <div class="mt-6 flex flex-wrap gap-4 justify-center">
    <button id="process" disabled 
            class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="sparkles"></i> Procesar
    </button>
    <button id="toggle" disabled 
            class="bg-yellow-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="eye"></i> Overlay
    </button>
    <button id="clean" disabled 
            class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="brush"></i> Limpiar
    </button>
  </div>

  <!-- Vista antes/despuÃ©s -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
    <div class="bg-white p-4 rounded-xl shadow-md flex flex-col items-center">
      <h2 class="font-semibold mb-2">ðŸ“¥ Imagen Original</h2>
      <canvas id="canvasOriginal" class="max-w-full rounded-lg border"></canvas>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-md flex flex-col items-center">
      <h2 class="font-semibold mb-2">ðŸ§¹ Imagen Procesada</h2>
      <canvas id="canvasProcessed" class="max-w-full rounded-lg border"></canvas>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 pointer-events-none transition"></div>

  <script>
  const upload = document.getElementById('upload');
  const dropZone = document.getElementById('drop-zone');
  const processBtn = document.getElementById('process');
  const toggleBtn = document.getElementById('toggle');
  const cleanBtn = document.getElementById('clean');
  const canvasOriginal = document.getElementById('canvasOriginal');
  const ctxOriginal = canvasOriginal.getContext('2d');
  const canvasProcessed = document.getElementById('canvasProcessed');
  const ctxProcessed = canvasProcessed.getContext('2d');
  const toast = document.getElementById('toast');

  let originalImage = null;
  let overlayData = null;
  let overlayVisible = true;
  let semitransparentPixels = 0;

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.remove("opacity-0");
    toast.classList.add("opacity-100");
    setTimeout(() => {
      toast.classList.remove("opacity-100");
      toast.classList.add("opacity-0");
    }, 3000);
  }

  // Drag & Drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add("border-blue-500", "bg-blue-50");
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove("border-blue-500", "bg-blue-50");
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-blue-500", "bg-blue-50");
    const file = e.dataTransfer.files[0];
    if (file && file.type === "image/png") {
      loadImage(file);
    } else {
      showToast("âš ï¸ Solo se permiten imÃ¡genes PNG.");
    }
  });

  // Subida normal
  upload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) loadImage(file);
  });

  function loadImage(file) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        canvasOriginal.width = img.width;
        canvasOriginal.height = img.height;
        canvasProcessed.width = img.width;
        canvasProcessed.height = img.height;

        ctxOriginal.drawImage(img, 0, 0);
        ctxProcessed.drawImage(img, 0, 0);

        originalImage = img;
        processBtn.disabled = false;
        toggleBtn.disabled = true;
        cleanBtn.disabled = true;
        showToast("âœ… Imagen cargada correctamente.");
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  // Procesar semitransparencias
  processBtn.addEventListener('click', () => {
    if (!originalImage) return;
    ctxProcessed.drawImage(originalImage, 0, 0);
    const imgData = ctxProcessed.getImageData(0, 0, canvasProcessed.width, canvasProcessed.height);
    const data = imgData.data;

    overlayData = ctxProcessed.createImageData(imgData);
    semitransparentPixels = 0;

    for (let i = 0; i < data.length; i += 4) {
      const alpha = data[i + 3];
      if (alpha > 0 && alpha < 255) {
        overlayData.data[i] = 255;
        overlayData.data[i + 1] = 0;
        overlayData.data[i + 2] = 0;
        overlayData.data[i + 3] = 128;
        semitransparentPixels++;
      } else {
        overlayData.data[i + 3] = 0;
      }
    }

    ctxProcessed.putImageData(imgData, 0, 0);
    ctxProcessed.putImageData(overlayData, 0, 0);

    toggleBtn.disabled = false;
    cleanBtn.disabled = false;
    showToast(`ðŸ” Detectados ${semitransparentPixels} pÃ­xeles semitransparentes.`);
  });

  // Toggle overlay
  toggleBtn.addEventListener('click', () => {
    overlayVisible = !overlayVisible;
    ctxProcessed.drawImage(originalImage, 0, 0);
    if (overlayVisible && overlayData) {
      ctxProcessed.putImageData(overlayData, 0, 0);
      showToast("ðŸ‘ï¸ Overlay activado.");
    } else {
      showToast("ðŸ™ˆ Overlay desactivado.");
    }
  });

  // Obtener siguiente nombre de archivo (almacenado en localStorage)
  function getNextFilename() {
    try {
      const key = 'limpiador_download_index';
      let idx = parseInt(localStorage.getItem(key) || '0', 10);
      if (isNaN(idx)) idx = 0;
      idx = idx + 1;
      localStorage.setItem(key, idx);
      return `imagen_limpia_${idx}.png`;
    } catch (e) {
      // Si localStorage falla (modo privado o bloqueo), usar timestamp
      const ts = Date.now();
      return `imagen_limpia_${ts}.png`;
    }
  }

  // Limpiar imagen y descargar con nombre incremental
  cleanBtn.addEventListener('click', () => {
    if (!originalImage) return;

    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = originalImage.width;
    tempCanvas.height = originalImage.height;
    tempCtx.drawImage(originalImage, 0, 0);

    const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const data = imgData.data;

    for (let i = 0; i < data.length; i += 4) {
      if (data[i + 3] > 0 && data[i + 3] < 255) {
        data[i + 3] = 255;
      }
    }

    ctxProcessed.putImageData(imgData, 0, 0);

    // Descargar automÃ¡ticamente con nombre incremental
    const filename = getNextFilename();
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvasProcessed.toDataURL();
    link.click();

    showToast(`ðŸ§¹ Se limpiaron ${semitransparentPixels} pÃ­xeles. Guardado como ${filename}`);
  });

  // Cargar Ã­conos Lucide
  lucide.createIcons();
  </script>
</body>
</html>
