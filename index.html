<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiador de Semitonos - Profesional</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center p-6">

  <!-- Logo -->
  <img src="https://taplink.st/a/7/a/4/9/c337e8.png" alt="Logo" class="mb-4 max-h-28">

  <!-- Header -->
  <h1 class="text-3xl font-bold text-blue-400 mb-4">Limpiador de Semitonos</h1>
  <p class="text-gray-400 max-w-2xl text-center mb-6">
    Esta herramienta detecta y corrige <strong>√°reas semitransparentes</strong> en im√°genes PNG.
    Te permite visualizar en color blanco d√≥nde est√°n los p√≠xeles con transparencia parcial y generar una versi√≥n
    limpia lista para impresi√≥n DTF u otros usos profesionales.
  </p>

  <!-- Zona de carga -->
  <div id="drop-zone"
       class="w-full max-w-xl border-2 border-dashed border-gray-600 bg-gray-800 rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-gray-700 transition">
    <p class="text-gray-400 mb-2">Arrastra una imagen PNG aqu√≠ o</p>
    <input type="file" id="upload" accept="image/png" class="hidden">
    <button onclick="document.getElementById('upload').click()"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
      <i data-lucide="upload"></i> Subir Imagen
    </button>
  </div>

  <!-- Botones -->
  <div class="mt-6 flex flex-wrap gap-4 justify-center">
    <button id="process" disabled
            class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="sparkles"></i> Procesar
    </button>
    <button id="toggle" disabled
            class="bg-yellow-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="eye"></i> Overlay
    </button>
    <button id="clean" disabled
            class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
      <i data-lucide="brush"></i> Limpiar y descargar
    </button>
  </div>

  <!-- Vista antes/despu√©s -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
    <div class="bg-gray-700 p-4 rounded-xl shadow-md flex flex-col items-center">
      <h2 class="font-semibold mb-2">üì• Imagen Original</h2>
      <canvas id="canvasOriginal" class="max-w-full rounded-lg border border-gray-600"></canvas>
    </div>
    <div class="bg-gray-700 p-4 rounded-xl shadow-md flex flex-col items-center">
      <h2 class="font-semibold mb-2">üßπ Imagen Procesada</h2>
      <canvas id="canvasProcessed" class="max-w-full rounded-lg border border-gray-600"></canvas>
    </div>
  </div>

  <!-- Info semitransparencias -->
  <p id="info" class="mt-4 text-gray-400"></p>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-gray-700 text-white px-4 py-2 rounded-lg opacity-0 pointer-events-none transition"></div>

  <script>
    const upload = document.getElementById('upload');
    const dropZone = document.getElementById('drop-zone');
    const processBtn = document.getElementById('process');
    const toggleBtn = document.getElementById('toggle');
    const cleanBtn = document.getElementById('clean');
    const canvasOriginal = document.getElementById('canvasOriginal');
    const ctxOriginal = canvasOriginal.getContext('2d');
    const canvasProcessed = document.getElementById('canvasProcessed');
    const ctxProcessed = canvasProcessed.getContext('2d');
    const toast = document.getElementById('toast');
    const info = document.getElementById('info');

    let originalImage = null;
    let overlayData = null;
    let overlayVisible = true;
    let semitransparentPixels = 0;

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove("opacity-0");
      toast.classList.add("opacity-100");
      setTimeout(() => {
        toast.classList.remove("opacity-100");
        toast.classList.add("opacity-0");
      }, 3000);
    }

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add("border-blue-400", "bg-gray-700");
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove("border-blue-400", "bg-gray-700");
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove("border-blue-400", "bg-gray-700");
      const file = e.dataTransfer.files[0];
      if (file && file.type === "image/png") {
        loadImage(file);
      } else {
        showToast("‚ö†Ô∏è Solo se permiten im√°genes PNG.");
      }
    });

    // Subida normal
    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) loadImage(file);
    });

    function loadImage(file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          canvasOriginal.width = img.width;
          canvasOriginal.height = img.height;
          canvasProcessed.width = img.width;
          canvasProcessed.height = img.height;

          ctxOriginal.drawImage(img, 0, 0);
          ctxProcessed.drawImage(img, 0, 0);

          originalImage = img;
          processBtn.disabled = false;
          toggleBtn.disabled = true;
          cleanBtn.disabled = true;
          info.textContent = '';
          showToast("‚úÖ Imagen cargada correctamente.");
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Procesar semitransparencias
    processBtn.addEventListener('click', () => {
      if (!originalImage) return;
      ctxProcessed.drawImage(originalImage, 0, 0);
      const imgData = ctxProcessed.getImageData(0, 0, canvasProcessed.width, canvasProcessed.height);
      const data = imgData.data;

      overlayData = ctxProcessed.createImageData(imgData);
      semitransparentPixels = 0;

     for (let i = 0; i < data.length; i += 4) {
  const alpha = data[i + 3];
  if (alpha > 0 && alpha < 255) {
    overlayData.data[i] = 255;     // R
    overlayData.data[i + 1] = 255; // G
    overlayData.data[i + 2] = 255; // B
    overlayData.data[i + 3] = 128; // Transparencia del overlay
    semitransparentPixels++;
  } else {
    overlayData.data[i + 3] = 0; // p√≠xel transparente en el overlay
  }
}

      ctxProcessed.putImageData(imgData, 0, 0);
      ctxProcessed.putImageData(overlayData, 0, 0);

      toggleBtn.disabled = false;
      cleanBtn.disabled = false;
      info.textContent = `üîç Total de p√≠xeles semitransparentes detectados: ${semitransparentPixels}`;
      showToast(`üîç Detectados ${semitransparentPixels} p√≠xeles semitransparentes.`);
    });

    // Toggle overlay
    toggleBtn.addEventListener('click', () => {
      overlayVisible = !overlayVisible;
      ctxProcessed.drawImage(originalImage, 0, 0);
      if (overlayVisible && overlayData) {
        ctxProcessed.putImageData(overlayData, 0, 0);
        showToast("üëÅÔ∏è Overlay activado.");
      } else {
        showToast("üôà Overlay desactivado.");
      }
    });

    // Obtener siguiente nombre de archivo
    function getNextFilename() {
      try {
        const key = 'limpiador_download_index';
        let idx = parseInt(localStorage.getItem(key) || '0', 10);
        if (isNaN(idx)) idx = 0;
        idx = idx + 1;
        localStorage.setItem(key, idx);
        return `imagen_limpia_${idx}.png`;
      } catch (e) {
        const ts = Date.now();
        return `imagen_limpia_${ts}.png`;
      }
    }

    // Limpiar imagen y descargar
    cleanBtn.addEventListener('click', () => {
      if (!originalImage) return;

      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = originalImage.width;
      tempCanvas.height = originalImage.height;
      tempCtx.drawImage(originalImage, 0, 0);

      const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imgData.data;

      let cleanedPixels = 0;
      for (let i = 0; i < data.length; i += 4) {
        if (data[i + 3] > 0 && data[i + 3] < 255) {
          data[i + 3] = 255;
          cleanedPixels++;
        }
      }

      ctxProcessed.putImageData(imgData, 0, 0);

      const filename = getNextFilename();
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvasProcessed.toDataURL();
      link.click();

      showToast(`üßπ Se limpiaron ${cleanedPixels} p√≠xeles. Guardado como ${filename}`);
      info.textContent = `‚úÖ Se limpiaron ${cleanedPixels} p√≠xeles semitransparentes.`;
    });

    // Cargar √≠conos Lucide
    lucide.createIcons();
  </script>
</body>
</html>
